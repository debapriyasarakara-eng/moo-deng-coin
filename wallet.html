<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Moo Deng Coin Wallet</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
  /* ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ CSS ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
  body { background: #0d0d0d; color: #fff; display: flex; justify-content: center; min-height: 100vh; padding: 20px; }
  .container { max-width: 480px; width: 100%; background: #111; padding: 20px; border-radius: 10px; box-shadow: 0 0 25px rgba(0, 255, 221, 0.3); }
  h1 { font-family: 'Cinzel Decorative', serif; font-weight: 700; font-size: 28px; background: linear-gradient(90deg, #ffd700, #ffa500); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: glow 2s infinite alternate; display: flex; align-items: center; gap: 10px; }
  @keyframes glow { from {text-shadow: 0 0 5px #ffd700;} to {text-shadow: 0 0 20px #ffa500;} }
  .coin-symbol { width: 48px; aspect-ratio: 1 / 1; border-radius: 50%; background: radial-gradient(circle, #ffd700 10%, #ffa500 70%, #b8860b 100%); display: inline-flex; align-items: center; justify-content: center; font-size: 24px; color: #000; font-weight: bold; box-shadow: 0 0 15px rgba(255, 215, 0, 0.9), inset 0 0 6px #fff; }
  button, input { font-family: inherit; font-size: 16px; }
  button { cursor: pointer; border-radius: 5px; border: none; padding: 10px 20px; font-weight: 700; transition: background 0.3s ease; }
  button:disabled { cursor: not-allowed; opacity: 0.6; }
  .auth-section { display: flex; flex-direction: column; gap: 16px; text-align: center; }
  .wallet-section { display: none; flex-direction: column; gap: 16px; user-select: none; }
  .wallet-section.active { display: flex; }
  .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  #logoutBtn { background: #ff4444; color: #fff; }
  .balance-section, .transfer-section, .history-section, .wallet-address-section { background: #222; padding: 15px; border-radius: 10px; box-shadow: inset 0 0 10px #00ffdd55; margin-bottom: 20px; }
  .balance-section span { color: #00ffdd; font-weight: bold; font-size: 24px; }
  .transfer-section label { font-weight: bold; color: #00ffdd; }
  .transfer-section input { width: 100%; padding: 10px; border-radius: 6px; border: none; font-weight: bold; margin-top: 6px; color: #fff; background: #111; outline: none; }
  #transferBtn { background: linear-gradient(90deg, #ffd700, #ffa500); color: #111; margin-top: 10px; font-weight: 700; width: 100%; }
  #transferBtn:hover:not(:disabled) { background: linear-gradient(90deg, #ffa500, #ffd700); transform: scale(1.05); }
  #transferBtn:disabled { background: #444; color: #999; }
  #historyList { max-height: 200px; overflow-y: auto; list-style-type: none; color: #0ff; font-weight: bold; font-size: 14px; padding-left: 10px; }
  .status-message { margin-top: 8px; font-size: 14px; }
  .wallet-address-section { margin-top: 20px; }
  .wallet-address-section h2 { margin-bottom: 10px; color: #ffd700; }
  .wallet-address-box { background: #111; padding: 10px; border-radius: 8px; border: 1px dashed #00ffdd; display: flex; justify-content: space-between; align-items: center; }
  #walletAddressText { font-size: 14px; word-break: break-all; color: #00ffdd; user-select: all; }
  #copyAddressBtn { background: #00ffdd; color: #000; padding: 5px 10px; font-size: 12px; }
  .history-item { background: #333; padding: 10px; border-radius: 8px; margin-bottom: 8px; position: relative; }
  .history-item p { margin: 0; line-height: 1.4; }
  .history-item .date { font-size: 12px; color: #aaa; }
  .history-item .status { font-weight: bold; }
  .sent { color: #ff4444; }
  .received { color: #00ffdd; }
  .history-item .copy-history-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: #555;
    color: #fff;
    padding: 3px 8px;
    font-size: 10px;
    border-radius: 4px;
    opacity: 0.7;
    transition: opacity 0.3s;
  }
  .history-item .copy-history-btn:hover {
    opacity: 1;
  }
  
  /* New CSS for animated balance and welcome message */
  .balance-section.shake {
    animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
  }
  @keyframes shake {
    10%, 90% { transform: translate3d(-1px, 0, 0); }
    20%, 80% { transform: translate3d(2px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
    40%, 60% { transform: translate3d(4px, 0, 0); }
  }
  #welcomeMessage {
      font-size: 18px;
      color: #ffd700;
      font-weight: bold;
      margin-bottom: 10px;
  }
  
  /* New CSS for Market Value tab */
  .market-value-section {
    background: #222;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    border: 2px solid #00ffdd;
    text-align: center;
  }
  .market-value-section h2 {
    color: #ffd700;
    margin-bottom: 5px;
  }
  .market-value-section p {
    font-size: 20px;
    font-weight: bold;
    color: #00ffdd;
    letter-spacing: 1px;
  }

  /* New CSS for Recent Subscribers */
  .recent-subscribers-section {
    margin-top: 20px;
    background: #1e1e1e;
    padding: 15px;
    border-radius: 10px;
  }
  .recent-subscribers-section h3 {
    color: #00ffdd;
    text-align: center;
    margin-bottom: 10px;
  }
  .subscriber-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .subscriber-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px;
    background: #333;
    border-radius: 8px;
    margin-bottom: 8px;
    color: #fff;
  }
  .subscriber-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #007bff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    color: #fff;
  }
  .subscriber-info {
    flex-grow: 1;
  }
  .subscriber-name {
    font-weight: bold;
    font-size: 16px;
  }
  .subscriber-time {
    font-size: 12px;
    color: #aaa;
  }
  .subscriber-flag {
    width: 30px;
    height: 20px;
    border-radius: 3px;
    object-fit: cover;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
  }
</style>
</head>

<body>
<div class="container">
  <div class="auth-section" id="authSection">
    <h1>Moo Deng Coin Wallet</h1>
    <p>Sign in with your Google account to access your wallet.</p>
    <button id="signInBtn">Sign in with Google</button>
    
    <div class="recent-subscribers-section">
      <h3>Recent Subscribers</h3>
      <ul class="subscriber-list" id="recentSubscribersAuth"></ul>
    </div>
  </div>

  <div class="wallet-section" id="walletSection">
    <div class="app-header">
      <h1>Moo Deng Coin Wallet <span class="coin-symbol">ü¶õ</span></h1>
      <button id="logoutBtn">Logout</button>
    </div>
    
    <p id="welcomeMessage"></p>

    <div class="wallet-address-section">
        <h2>Your MDC Wallet Address</h2>
        <div class="wallet-address-box">
            <span id="walletAddressText"></span>
            <button id="copyAddressBtn"><i class="fas fa-copy"></i></button>
        </div>
    </div>
    
    <div class="balance-section">
      <h2>Balance</h2>
      <p><span id="balance">0</span> MDC</p>
    </div>
    
    <div class="market-value-section">
      <h2>MDC's Market Value</h2>
      <p>Around **$0.000452**</p>
    </div>

    <div class="transfer-section">
      <h2>Transfer Tokens</h2>
      <label for="receiverIdInput">Receiver Wallet ID</label>
      <input type="text" id="receiverIdInput" placeholder="Enter receiver wallet ID" autocomplete="off" spellcheck="false" />
      <label for="transferAmountInput" style="margin-top: 10px;">Amount to Transfer</label>
      <input type="number" id="transferAmountInput" min="1" placeholder="Enter amount" />
      <button id="transferBtn" disabled>Transfer</button>
      <p id="transferStatus" class="status-message"></p>
    </div>

    <div class="history-section">
      <h2>Transaction History</h2>
      <ul id="historyList"></ul>
    </div>
    
    <div class="recent-subscribers-section">
      <h3>Recent Subscribers</h3>
      <ul class="subscriber-list" id="recentSubscribersWallet"></ul>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, runTransaction, onSnapshot, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBRitTsyqXfk6XNh3t1j0boebQa1LNQkKs",
    authDomain: "moo-deng-coin.firebaseapp.com",
    projectId: "moo-deng-coin",
    storageBucket: "moo-deng-coin.firebasestorage.app",
    messagingSenderId: "629636349388",
    appId: "1:629636349388:web:a9a7924aaea9354a09f169",
    measurementId: "G-T7FVX8DW2Z"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // DOM elements
  const authSection = document.getElementById("authSection");
  const walletSection = document.getElementById("walletSection");
  const signInBtn = document.getElementById("signInBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const balanceEl = document.getElementById("balance");
  const receiverIdInput = document.getElementById("receiverIdInput");
  const transferAmountInput = document.getElementById("transferAmountInput");
  const transferBtn = document.getElementById("transferBtn");
  const transferStatus = document.getElementById("transferStatus");
  const historyList = document.getElementById("historyList");
  const walletAddressText = document.getElementById("walletAddressText");
  const copyAddressBtn = document.getElementById("copyAddressBtn");
  const welcomeMessage = document.getElementById("welcomeMessage");
  const recentSubscribersAuthList = document.getElementById("recentSubscribersAuth");
  const recentSubscribersWalletList = document.getElementById("recentSubscribersWallet");
  
  let userDocRef = null;
  let unsubscribeSnapshot = null;

  // Function to show/hide sections
  function showAuthSection() {
      authSection.style.display = 'flex';
      walletSection.style.display = 'none';
  }
  function showWalletSection() {
      authSection.style.display = 'none';
      walletSection.style.display = 'flex';
  }
  
  // New function to fetch and render recent subscribers
  function fetchAndRenderRecentSubscribers() {
    const q = query(collection(db, "walletUsers"), orderBy("signupTime", "desc"), limit(10));
    
    onSnapshot(q, (querySnapshot) => {
      const subscribers = [];
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const timeAgo = Math.floor((Date.now() - (data.signupTime || Date.now())) / 60000); // in minutes
        const minutesAgo = timeAgo > 0 ? `${timeAgo} minutes ago` : `Just now`;
        
        let userName = data.name || data.email || "User";
        if (userName.includes('@')) {
          userName = userName.split('@')[0];
        }
        
        // Placeholder country logic (needs a lookup table for real countries)
        let countryFlag = 'üáÆüá≥'; // Default to India
        if (data.country) {
            // A more complex system would map country names to flags
            // For now, this is a placeholder. You can expand this logic.
            countryFlag = data.country.flag || 'üáÆüá≥'; 
        }

        subscribers.push({
          initial: userName.charAt(0).toUpperCase(),
          name: userName,
          time: minutesAgo,
          flag: countryFlag
        });
      });
      renderSubscribers(subscribers, recentSubscribersAuthList);
      renderSubscribers(subscribers, recentSubscribersWalletList);
    });
  }

  function renderSubscribers(subscribers, listElement) {
    listElement.innerHTML = "";
    subscribers.forEach(sub => {
      const li = document.createElement("li");
      li.classList.add("subscriber-item");
      li.innerHTML = `
        <div class="subscriber-avatar">${sub.initial}</div>
        <div class="subscriber-info">
          <div class="subscriber-name">${sub.name}</div>
          <div class="subscriber-time">${sub.time}</div>
        </div>
        <div class="subscriber-flag">${sub.flag}</div>
      `;
      listElement.appendChild(li);
    });
  }

  // Handle Google Sign-in
  signInBtn.addEventListener('click', async () => {
    try {
        await signInWithPopup(auth, provider);
    } catch (error) {
        console.error("Sign-in error:", error);
    }
  });

  // Handle Logout
  logoutBtn.addEventListener('click', async () => {
      if (unsubscribeSnapshot) {
          unsubscribeSnapshot();
      }
      await signOut(auth);
      showAuthSection();
      // Clear UI elements
      balanceEl.textContent = '0';
      walletAddressText.textContent = '';
      historyList.innerHTML = '';
      transferStatus.textContent = '';
      transferAmountInput.value = '';
      receiverIdInput.value = '';
      welcomeMessage.textContent = '';
  });

  // Authentication State Listener
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      userDocRef = doc(db, 'walletUsers', user.uid);
      walletAddressText.textContent = user.uid;
      
      const docSnap = await getDoc(userDocRef);
      if (!docSnap.exists()) {
        await setDoc(userDocRef, {
            name: user.displayName || "",
            email: user.email,
            balance: 0,
            createdAt: Date.now(),
            history: []
        });
      }
      
      // Update welcome message
      const displayName = user.displayName ? user.displayName.split(' ')[0] : 'User';
      welcomeMessage.textContent = `Welcome to MDC Wallet, ${displayName}!`;

      unsubscribeSnapshot = onSnapshot(userDocRef, (doc) => {
          if (doc.exists()) {
              const data = doc.data();
              balanceEl.textContent = data.balance || 0;
              renderTransactionHistory(data.history || []);

              // Animate balance
              const balanceSection = document.querySelector('.balance-section');
              balanceSection.classList.add('shake');
              setTimeout(() => {
                  balanceSection.classList.remove('shake');
              }, 500);
          }
      });
      
      showWalletSection();
    } else {
      showAuthSection();
      if (unsubscribeSnapshot) {
          unsubscribeSnapshot();
      }
    }
  });

  // Render transaction history
  function renderTransactionHistory(transactions) {
    historyList.innerHTML = "";
    if (transactions.length === 0) {
      const li = document.createElement("li");
      li.textContent = "No transaction history found.";
      li.style.fontStyle = "italic";
      li.style.color = "#555";
      historyList.appendChild(li);
      return;
    }
    transactions.slice().reverse().forEach(tx => {
      const li = document.createElement("li");
      li.classList.add("history-item");
      const date = new Date(tx.time || tx.timestamp).toLocaleString();
      
      let htmlContent = '';
      let copyText = '';
      if (tx.type === 'sent') {
          htmlContent = `<p class="status sent">Sent</p>
                         <p>To: ${tx.receiverId}</p>
                         <p>Amount: ${tx.amount} MDC</p>
                         <p class="date">${date}</p>`;
          copyText = `Sent ${tx.amount} MDC to ${tx.receiverId} on ${date}.`;
      } else if (tx.type === 'received') {
          htmlContent = `<p class="status received">Received</p>
                         <p>From: ${tx.senderId}</p>
                         <p>Amount: ${tx.amount} MDC</p>
                         <p class="date">${date}</p>`;
          copyText = `Received ${tx.amount} MDC from ${tx.senderId} on ${date}.`;
      } else if (tx.type === 'mine') {
          htmlContent = `<p class="status received">Mined</p>
                         <p>Amount: ${tx.amount} MDC</p>
                         <p class="date">${date}</p>`;
          copyText = `Mined ${tx.amount} MDC on ${date}.`;
      } else if (tx.type === 'luckyBox') {
          htmlContent = `<p class="status received">Lucky Box</p>
                         <p>Amount: ${tx.amount} MDC</p>
                         <p class="date">${date}</p>`;
          copyText = `Won ${tx.amount} MDC from Lucky Box on ${date}.`;
      }
      
      li.innerHTML = htmlContent + `<button class="copy-history-btn" data-copy-text="${copyText}"><i class="fas fa-copy"></i></button>`;
      historyList.appendChild(li);
    });

    document.querySelectorAll('.copy-history-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const textToCopy = e.currentTarget.dataset.copyText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert("Transaction details copied!");
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        });
    });
  }

  // Validate transfer inputs
  function validateTransferInputs() {
    const receiverId = receiverIdInput.value.trim();
    const amount = Number(transferAmountInput.value);
    const maxBalance = Number(balanceEl.textContent);
    transferBtn.disabled = !(receiverId.length > 0 && amount > 0 && amount <= maxBalance && receiverId !== auth.currentUser.uid);
  }
  receiverIdInput.addEventListener("input", validateTransferInputs);
  transferAmountInput.addEventListener("input", validateTransferInputs);

  // Token transfer handler
  transferBtn.addEventListener("click", async () => {
    transferStatus.style.color = "#00ff00";
    transferStatus.textContent = "Processing transfer...";
    transferBtn.disabled = true;

    const receiverId = receiverIdInput.value.trim();
    const amount = Number(transferAmountInput.value);
    const senderId = auth.currentUser.uid;

    if (receiverId === senderId) {
      transferStatus.style.color = "#ff5555";
      transferStatus.textContent = "Cannot transfer to your own wallet.";
      transferBtn.disabled = false;
      return;
    }

    try {
      const receiverDocRef = doc(db, "walletUsers", receiverId);
      await runTransaction(db, async (transaction) => {
        const senderDoc = await transaction.get(userDocRef);
        const receiverDoc = await transaction.get(receiverDocRef);

        if (!senderDoc.exists()) throw new Error("Sender wallet does not exist.");
        if (!receiverDoc.exists()) throw new Error("Receiver wallet ID not found.");

        const senderData = senderDoc.data();
        const receiverData = receiverDoc.data();

        if ((senderData.balance || 0) < amount) throw new Error("Insufficient balance.");
        
        // Add transaction history for both sender and receiver
        const newSenderHistory = [...(senderData.history || []), {
          timestamp: Date.now(),
          amount,
          receiverId,
          type: 'sent'
        }];
        const newReceiverHistory = [...(receiverData.history || []), {
          timestamp: Date.now(),
          amount,
          senderId,
          type: 'received'
        }];

        // Update balances and history
        transaction.update(userDocRef, {
          balance: senderData.balance - amount,
          history: newSenderHistory
        });

        transaction.update(receiverDocRef, {
          balance: (receiverData.balance || 0) + amount,
          history: newReceiverHistory
        });
      });

      transferStatus.style.color = "#00ff00";
      transferStatus.textContent = "Transfer successful!";
      receiverIdInput.value = "";
      transferAmountInput.value = "";
    } catch (error) {
      transferStatus.style.color = "#ff5555";
      transferStatus.textContent = "Transfer failed: " + error.message;
      console.error("Transaction failed: ", error);
    } finally {
      transferBtn.disabled = false;
    }
  });

  // Copy Wallet Address
  copyAddressBtn.addEventListener("click", () => {
    if (auth.currentUser) {
        navigator.clipboard.writeText(auth.currentUser.uid).then(() => {
            alert("Wallet Address copied to clipboard!");
        });
    }
  });
  
  // Initial call to fetch subscribers
  fetchAndRenderRecentSubscribers();
</script>
</body>
</html>
