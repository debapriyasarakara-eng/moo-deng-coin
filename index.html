<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Moo Deng Coin</title>
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family: Arial, sans-serif;}
body {background:#0d0d0d; color:#fff; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; padding:20px;}
a {color:#00ffdd; text-decoration:none;}
button {cursor:pointer; background:#00ffdd; border:none; padding:10px 20px; color:#000; font-weight:bold; border-radius:5px; transition:0.3s;}
button:hover {background:#00ccaa;}
.container {max-width:450px; width:100%; background:#111; padding:20px; border-radius:10px; box-shadow:0 0 20px rgba(0,255,221,0.3);}
h1,h2,h3 {margin-bottom:10px;}
.wallet, .referral, .tabs, .tab-content {margin-top:20px;}
.wallet span, .referral span {font-weight:bold; color:#00ffdd;}
.mining-container {position:relative; width:200px; height:200px; margin:20px auto;}
.circle {width:100%; height:100%; border-radius:50%; border:5px solid #00ffdd; display:flex; justify-content:center; align-items:center; font-size:20px; font-weight:bold; position:relative;}
.circle::after {content:''; position:absolute; width:100%; height:100%; border-radius:50%; border:5px solid rgba(0,255,221,0.3); animation: rotateCircle linear infinite;}
@keyframes rotateCircle {from{transform:rotate(0deg);} to{transform:rotate(360deg);}}
.tabs {display:flex; justify-content:space-around;}
.tabs button {flex:1; margin:0 5px;}
.tab-content {display:none; margin-top:20px; background:#111; padding:15px; border-radius:10px;}
.referral-link {display:flex; justify-content:space-between; align-items:center; margin-top:10px;}
input.copy-input {width:70%; padding:5px; border-radius:5px; border:none;}
.logout-warning {margin-top:15px; color:#ff5555; font-weight:bold; text-align:center;}
.profile-pic {width:50px; height:50px; border-radius:50%; background:#333; display:flex; justify-content:center; align-items:center; font-size:20px; margin-right:10px; cursor:pointer;}
.header-flex {display:flex; align-items:center; justify-content:space-between;}
.logout-btn {margin-left:10px;}
.copy-btn {padding:5px 10px; font-size:14px; border-radius:5px; background:#00ffdd; border:none; cursor:pointer;}
</style>
</head>
<body>

<div class="container" id="authContainer">

  <!-- Authentication -->
  <h2>Sign In / Sign Up</h2>

  <!-- Google Sign-In -->
  <button id="googleSignInBtn">Sign in with Google</button>

  <hr style="margin:20px 0;">

  <!-- Email Signup -->
  <input type="text" id="signupName" placeholder="Name" style="width:100%; padding:8px; margin-bottom:10px;">
  <input type="email" id="signupEmail" placeholder="Email" style="width:100%; padding:8px; margin-bottom:10px;">
  <input type="password" id="signupPass" placeholder="Password" style="width:100%; padding:8px; margin-bottom:10px;">
  <button id="signupBtn">Sign Up</button>

  <hr style="margin:20px 0;">

  <!-- Email Login -->
  <input type="email" id="loginEmail" placeholder="Email" style="width:100%; padding:8px; margin-bottom:10px;">
  <input type="password" id="loginPass" placeholder="Password" style="width:100%; padding:8px; margin-bottom:10px;">
  <button id="loginBtn">Login</button>

</div>

<div class="container" id="mainContainer" style="display:none;">

  <!-- Header with Profile and Logout -->
  <div class="header-flex">
    <div class="profile-pic" id="profilePic">üë§</div>
    <h1>Moo Deng Coin</h1>
    <button class="logout-btn" id="logoutBtn">Logout</button>
  </div>

  <!-- Wallet -->
  <div class="wallet">
    <h2>Wallet</h2>
    <p>MDC Balance: <span id="balance">0</span></p>
    <button id="mineBtn">Mine Token</button>
    <p class="logout-warning">
      ‚≠ê Keep this tab open! Closing will stop mining. You can safely minimize.
    </p>
  </div>

  <!-- Mining Circle -->
  <div class="mining-container">
    <div class="circle">
      <span id="timerText">00:00:00</span>
    </div>
  </div>

  <!-- Referral -->
  <div class="referral">
    <h3>Your Referral</h3>
    <p>Your Referral Code: <span id="refCode"></span></p>
    <div class="referral-link">
      <input class="copy-input" id="refLink" readonly>
      <button class="copy-btn" id="copyBtn">Copy</button>
    </div>
    <p>Referred Users: <span id="refCount">0</span></p>
    <p>Bonus: 2% from referrals for 7 days</p>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button data-tab="historyTab">History</button>
    <button data-tab="whitelistTab">white paper</button>
  </div>

  <!-- Tab Contents -->
  <div class="tab-content" id="historyTab">
    <h3>Mining History</h3>
    <ul id="historyList"></ul>
  </div>
  <div class="tab-content" id="whitelistTab">
    <h3>White paper</h3>
    <p>Update your whitelist here later.</p>
    <button style="background:#ff5555; color:#fff;">Withdrawal Coming Soon</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { 
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { 
  getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion 
} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBRitTsyqXfk6XNh3t1j0boebQa1LNQkKs",
  authDomain: "moo-deng-coin.firebaseapp.com",
  projectId: "moo-deng-coin",
  storageBucket: "moo-deng-coin.appspot.com",
  messagingSenderId: "629636349388",
  appId: "1:629636349388:web:a9a7924aaea9354a09f169",
  measurementId: "G-T7FVX8DW2Z"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Elements
const authContainer = document.getElementById('authContainer');
const mainContainer = document.getElementById('mainContainer');

const signupName = document.getElementById('signupName');
const signupEmail = document.getElementById('signupEmail');
const signupPass = document.getElementById('signupPass');
const signupBtn = document.getElementById('signupBtn');

const loginEmail = document.getElementById('loginEmail');
const loginPass = document.getElementById('loginPass');
const loginBtn = document.getElementById('loginBtn');

const googleSignInBtn = document.getElementById('googleSignInBtn');

const logoutBtn = document.getElementById('logoutBtn');

const balanceEl = document.getElementById('balance');
const mineBtn = document.getElementById('mineBtn');
const timerText = document.getElementById('timerText');

const refCodeEl = document.getElementById('refCode');
const refLinkInput = document.getElementById('refLink');
const copyBtn = document.getElementById('copyBtn');

const historyList = document.getElementById('historyList');

const tabs = document.querySelectorAll('.tabs button');
const tabContents = document.querySelectorAll('.tab-content');

// Referral code from URL
let urlParams = new URLSearchParams(window.location.search);
let refCodeFromURL = urlParams.get('ref') || null;

let userDocRef = null;
let miningTimer = null;

let userData = {
  balance: 0,
  mines: 0,
  lastMine: 0,
  referrals: 0,
  history: [],
  referredBy: null,
  signupTime: 0
};

const MINE_INTERVAL = 2 * 60 * 60 * 1000; // 2 hours
const MAX_DAILY_MINES = 5;

// Show referral UI update
function updateReferralUI(uid) {
  userDocRef = doc(db, "users", uid);
  getDoc(userDocRef).then((docSnap) => {
    if (docSnap.exists()) {
      const data = docSnap.data();
      refCodeEl.textContent = data.refCode || uid;
      refLinkInput.value = window.location.href.split('?')[0] + '?ref=' + (data.refCode || uid);
      document.getElementById('refCount').textContent = data.referrals || 0;
    }
  });
}

// Copy referral link
copyBtn.addEventListener('click', () => {
  refLinkInput.select();
  document.execCommand('copy');
  alert('Referral link copied!');
});

// UI Tabs logic
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabContents.forEach(tc => tc.style.display = 'none');
    document.getElementById(tab.dataset.tab).style.display = 'block';
  });
});

// Signup function
signupBtn.addEventListener('click', async () => {
  const name = signupName.value.trim();
  const email = signupEmail.value.trim();
  const pass = signupPass.value.trim();
  if (!name || !email || !pass) {
    alert('Please fill all fields');
    return;
  }
  try {
    let userCredential = await createUserWithEmailAndPassword(auth, email, pass);
    let user = userCredential.user;
    userDocRef = doc(db, "users", user.uid);

    // Save referral info during signup
    await setDoc(userDocRef, {
      name,
      email,
      balance: 0,
      mines: 0,
      lastMine: 0,
      referrals: 0,
      history: [],
      refCode: user.uid,
      referredBy: refCodeFromURL || null,
      signupTime: Date.now()
    });

    // Add referral bonus to referrer + count update
    if (refCodeFromURL) {
      const refUserRef = doc(db, "users", refCodeFromURL);
      const refUserSnap = await getDoc(refUserRef);
      if (refUserSnap.exists()) {
        await updateDoc(refUserRef, {
          balance: (refUserSnap.data().balance || 0) + 50,
          referrals: (refUserSnap.data().referrals || 0) + 1
        });
      }
    }

    await loadUserData(user.uid);
    afterLoginUI();
  } catch (error) {
    alert('Signup Error: ' + error.message);
  }
});

// Login function
loginBtn.addEventListener('click', async () => {
  const email = loginEmail.value.trim();
  const pass = loginPass.value.trim();
  if (!email || !pass) {
    alert('Please fill all fields');
    return;
  }
  try {
    let userCredential = await signInWithEmailAndPassword(auth, email, pass);
    let user = userCredential.user;
    await loadUserData(user.uid);
    afterLoginUI();
  } catch (error) {
    alert('Login Error: ' + error.message);
  }
});

// Google Sign-In with popup button disable to avoid double popup error
googleSignInBtn.addEventListener('click', async () => {
  googleSignInBtn.disabled = true;
  const provider = new GoogleAuthProvider();
  try {
    let result = await signInWithPopup(auth, provider);
    let user = result.user;
    userDocRef = doc(db, "users", user.uid);
    const docSnap = await getDoc(userDocRef);
    if (!docSnap.exists()) {
      await setDoc(userDocRef, {
        name: user.displayName || "",
        email: user.email,
        balance: 0,
        mines: 0,
        lastMine: 0,
        referrals: 0,
        history: [],
        refCode: user.uid,
        referredBy: refCodeFromURL || null,
        signupTime: Date.now()
      });

      // Add referral bonus to referrer + count update
      if (refCodeFromURL) {
        const refUserRef = doc(db, "users", refCodeFromURL);
        const refUserSnap = await getDoc(refUserRef);
        if (refUserSnap.exists()) {
          await updateDoc(refUserRef, {
            balance: (refUserSnap.data().balance || 0) + 50,
            referrals: (refUserSnap.data().referrals || 0) + 1
          });
        }
      }
    }
    await loadUserData(user.uid);
    afterLoginUI();
  } catch (error) {
    alert('Google Sign-In Error: ' + error.message);
  } finally {
    googleSignInBtn.disabled = false;
  }
});

// Logout function
logoutBtn.addEventListener('click', async () => {
  await signOut(auth);
  resetUI();
});

// Auth state observer
onAuthStateChanged(auth, async (user) => {
  if (user) {
    await loadUserData(user.uid);
    afterLoginUI();
  } else {
    resetUI();
  }
});

// Load user data from Firestore
async function loadUserData(uid) {
  userDocRef = doc(db, "users", uid);
  const docSnap = await getDoc(userDocRef);
  if (docSnap.exists()) {
    userData = docSnap.data();
    balanceEl.textContent = userData.balance || 0;
    updateReferralUI(userData.refCode || uid);
    renderHistory();
    updateMiningTimer();
  } else {
    userData = {
      balance: 0,
      mines: 0,
      lastMine: 0,
      referrals: 0,
      history: [],
      referredBy: null,
      signupTime: 0
    };
  }
}

// Update mining timer UI
function updateMiningTimer() {
  const now = Date.now();
  let remaining = userData.lastMine + MINE_INTERVAL - now;

  if (remaining <= 0 || userData.mines >= MAX_DAILY_MINES) {
    timerText.textContent = "Ready";
    mineBtn.disabled = false;
  } else {
    mineBtn.disabled = true;
    let hrs = Math.floor(remaining / 3600000);
    let mins = Math.floor((remaining % 3600000) / 60000);
    let secs = Math.floor((remaining % 60000) / 1000);

    timerText.textContent =`${
      hrs.toString().padStart(2, "0")
    }:${
      mins.toString().padStart(2, "0")
    }:${
      secs.toString().padStart(2, "0")
    }`;

    if(miningTimer) {
      cancelAnimationFrame(miningTimer);
    }
    miningTimer = requestAnimationFrame(updateMiningTimer);
  }
}

function renderHistory() {
  historyList.innerHTML = "";
  (userData.history || []).slice().reverse().forEach(item => {
    const li = document.createElement("li");
    li.textContent = `Mined 10 MDC at ${new Date(item.timestamp).toLocaleString()}`;
    historyList.appendChild(li);
  });
}

// Mining function with referral bonus logic
mineBtn.addEventListener('click', async () => {
  if (userData.mines >= MAX_DAILY_MINES) {
    alert('Daily mining limit reached!');
    return;
  }
  const now = Date.now();

  userData.balance += 10;
  userData.mines += 1;
  userData.lastMine = now;

  let newHistoryItem = { timestamp: now, amount: 10 };

  await updateDoc(userDocRef, {
    balance: userData.balance,
    mines: userData.mines,
    lastMine: userData.lastMine,
    history: arrayUnion(newHistoryItem)
  });

  // Referral bonus: 2% for 7 days
  if (userData.referredBy) {
    const refUserRef = doc(db, "users", userData.referredBy);
    const refUserSnap = await getDoc(refUserRef);
    if (refUserSnap.exists()) {
      const sevenDaysInMs = 7 * 24 * 60 * 60 * 1000;
      if ((Date.now() - userData.signupTime) <= sevenDaysInMs) {
        let bonus = 10 * 0.02; // 2% of 10
        await updateDoc(refUserRef, {
          balance: (refUserSnap.data().balance || 0) + bonus
        });
      }
    }
  }

  // Update UI
  balanceEl.textContent = userData.balance;
  userData.history.push(newHistoryItem);
  renderHistory();
  updateMiningTimer();
});

function afterLoginUI() {
  authContainer.style.display = "none";
  mainContainer.style.display = "block";
}

function resetUI() {
  authContainer.style.display = "block";
  mainContainer.style.display = "none";
  userData = {
    balance: 0,
    mines: 0,
    lastMine: 0,
    referrals: 0,
    history: [],
    referredBy: null,
    signupTime: 0
  };
  balanceEl.textContent = 0;
  historyList.innerHTML = "";
  timerText.textContent = "00:00:00";
  if(miningTimer) {
    cancelAnimationFrame(miningTimer);
  }
}

</script>
</body>
</html>
