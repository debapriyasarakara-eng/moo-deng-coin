<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Moo Deng Coin</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet" />
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#FFD700" />
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<style>
  * {margin:0; padding:0; box-sizing:border-box; font-family: Arial, sans-serif;}
  body {
    background: #0d0d0d; color: #fff;
    display: flex; justify-content: center;
    min-height: 100vh; padding: 20px;
  }
  .container {
    max-width: 450px; width: 100%;
    background: #111; padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 255, 221, 0.3);
  }
  h1, h2, h3 {
    margin-bottom: 10px;
  }

  /* Header */
  .app-header {
    display: flex; align-items: center; justify-content: space-between;
  }
  h1 {
    font-family: 'Cinzel Decorative', serif;
    font-weight: bold; font-size: 26px;
    background: linear-gradient(90deg, #FFD700, #FFA500);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: glow 2s infinite alternate;
    display: flex; align-items: center; gap: 8px;
    flex-wrap: wrap;
  }
  @keyframes glow {
    from {text-shadow: 0 0 5px #FFD700;}
    to {text-shadow: 0 0 20px #FFA500;}
  }
  .coin-symbol {
    width: 50px; aspect-ratio: 1/1; border-radius: 50%;
    background: radial-gradient(circle, #FFD700 10%, #FFA500 70%, #b8860b 100%);
    display: inline-flex; align-items: center; justify-content: center;
    font-size: 24px; color: #fff; font-weight: bold;
    margin-left: 6px;
    animation: coinPulse 2s infinite;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.9),
      inset 0 0 6px #fff;
  }
  @keyframes coinPulse {
    0% {transform: scale(1);}
    50% {transform: scale(1.15);}
    100% {transform: scale(1);}
  }
  .logout-btn {
    background: #ff4444; color: #fff; padding: 8px 14px;
    border: none; border-radius: 5px; cursor: pointer;
  }

  /* Auth container: center login button */
  #authContainer {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    text-align: center;
  }

  /* Google Sign In button */
  #googleSignInBtn {
    background: #fff; border: none; padding: 12px 20px;
    border-radius: 8px; font-size: 16px; font-weight: bold;
    cursor: pointer; display: flex; align-items: center;
    gap: 8px; color: #000;
    margin-top: 20px;
  }
  #googleSignInBtn i {
    font-size: 20px;
  }

  /* Install instructions below login */
  .install-instructions {
    margin-top: 20px; font-size: 14px;
    line-height: 1.6; color: #ccc; text-align: center;
  }
  .install-instructions h3 {
    color: #FFD700; margin-bottom: 10px;
  }

  /* Wallet, Referral, Tabs and Mine Button */
  .wallet, .referral, .tabs, .tab-content {margin-top: 20px;}
  .wallet span, .referral span {font-weight: bold; color: #00ffdd;}
  
  /* Mining Circle */
  .mining-container {
    position: relative;
    width: 220px;
    margin: 20px auto;
  }
  .circle {
    width: 100%; aspect-ratio: 1/1; border-radius: 50%;
    background:
      url('./coin.png') no-repeat center/cover,
      radial-gradient(circle at 30% 30%, #fff8b0 0%, #FFD700 30%, #FFA500 70%, #7a4a00 100%);
    display: flex; justify-content: center; align-items: center;
    font-size: 22px; font-weight: bold;
    color: #000;
    text-shadow: 0 0 4px #fff, 0 0 2px #000;
    box-shadow:
      inset -3px -3px 8px rgba(0,0,0,0.6),
      inset 3px 3px 6px rgba(255,255,255,0.6),
      0 0 20px rgba(255,215,0,0.6);
  }

  #mineBtn {
    display: block;
    margin: 20px auto;
    padding: 15px 25px;
    font-size: 18px;
    font-weight: bold;
    background: linear-gradient(90deg, #FFD700, #FFA500);
    border: none;
    border-radius: 50px;
    color: #111;
    box-shadow: 0 4px 10px rgba(255,215,0,0.5);
    cursor: pointer;
    transition: 0.3s;
  }
  #mineBtn:hover {
    background: linear-gradient(90deg, #FFA500, #FFD700);
    transform: scale(1.05);
  }

  /* Tabs */
  .tabs {
    display: flex;
    justify-content: space-around;
  }
  .tabs button {
    flex: 1;
    margin: 0 5px;
    padding: 10px;
    background: #00ffdd;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    color: #000;
    font-weight: bold;
  }
  .tab-content {
    display: none;
    margin-top: 20px;
    background: #111;
    padding: 15px;
    border-radius: 10px;
  }
  .tab-content.active {
    display: block;
  }

  /* Referral input and copy button styling */
  .referral input.copy-input {
    flex: 1;
    padding: 6px 10px;
    border: none;
    border-radius: 5px;
    background: #222;
    color: #0ff;
    font-weight: bold;
    font-size: 14px;
    user-select: all;
  }
  .referral .copy-btn {
    background: #00ffdd;
    border: none;
    border-radius: 5px;
    padding: 5px 12px;
    cursor: pointer;
    font-weight: bold;
    color: #000;
    margin-left: 8px;
  }

  /* Lucky Box Game styling */
  .game-section {
    margin-top: 30px;
    text-align: center;
  }
  .boxes {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
  }
  .boxes .box {
    width: 70px;
    height: 70px;
    background: linear-gradient(135deg, #ffd700, #ffa500);
    color: #fff;
    font-size: 28px;
    font-weight: bold;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(255, 165, 0, 0.6),
      inset 0 0 10px rgba(255, 255, 255, 0.3);
    border: 2px solid #fff5a1;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
    user-drag: none;
  }
  .boxes .box:hover {
    background: linear-gradient(135deg, #fff700, #ffb700);
    box-shadow: 0 6px 12px rgba(255, 215, 0, 0.8),
      inset 0 0 14px rgba(255, 255, 255, 0.6);
    transform: scale(1.1);
  }
  #gameResult {
    color: #0ff;
    font-weight: bold;
  }
  #claimBtn {
    display: none;
    background: #00ffdd;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    cursor: pointer;
    color: #000;
  }
</style>
</head>
<body>

<!-- Authentication Container -->
<div class="container" id="authContainer">
  <h2>Sign In</h2>
  <button id="googleSignInBtn"><i class="fab fa-google"></i> Sign in with Google</button>
  <div class="install-instructions">
    <h3>Install MDC</h3>
    <p>1. Tap on the ‚ãÆ menu in your browser's right corner.</p>
    <p>2. Scroll down and select "Add to Home Screen".</p>
    <p>3. Open MDC from your Home Screen!</p>
    <p>4. Keep this tab open to keep mining active.</p>
  </div>
</div>

<!-- Main Container -->
<div class="container" id="mainContainer" style="display:none;">
  <div class="app-header">
    <h1>Moo Deng COIN <span class="coin-symbol">ü¶õ</span></h1>
    <button id="logoutBtn" class="logout-btn">Logout</button>
  </div>

  <div class="wallet">
    <h2>Wallet</h2>
    <p>MDC Balance: <span id="balance">0</span></p>
    <button id="mineBtn">Mine Token</button>
  </div>

  <div class="mining-container">
    <div class="circle"><span id="timerText">00:00:00</span></div>
  </div>

  <!-- Referral Section -->
  <div class="referral">
    <h3>Your Referral</h3>
    <p>Code: <span id="refCode"></span></p>
    <div style="display:flex; gap:8px; margin-top: 10px;">
      <input class="copy-input" id="refLink" readonly>
      <button class="copy-btn" id="copyBtn">Copy</button>
    </div>
    <p>Referred Users: <span id="refCount">0</span></p>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button data-tab="historyTab">History</button>
    <button data-tab="whitepaperTab">White Paper</button>
  </div>
  <div class="tab-content" id="historyTab">
    <h3>Mining History</h3>
    <ul id="historyList"></ul>
  </div>
  <div class="tab-content" id="whitepaperTab">
    <h3>White Paper</h3>
    <p>Coming soon...</p>
  </div>

  <!-- Lucky Box Game -->
  <div class="game-section">
    <h3>Lucky Box Game üéÅ</h3>
    <p>You can play once every 24 hours. Pick a box and win 1‚Äì50 MDC randomly!</p>
    <div class="boxes">
      <div class="box" data-index="1">?</div>
      <div class="box" data-index="2">?</div>
      <div class="box" data-index="3">?</div>
      <div class="box" data-index="4">?</div>
      <div class="box" data-index="5">?</div>
    </div>
    <p id="gameResult"></p>
    <button id="claimBtn">Claim Coins</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, runTransaction } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBRitTsyqXfk6XNh3t1j0boebQa1LNQkKs",
    authDomain: "moo-deng-coin.firebaseapp.com",
    projectId: "moo-deng-coin",
    storageBucket: "moo-deng-coin.appspot.com",
    messagingSenderId: "629636349388",
    appId: "1:629636349388:web:a9a7924aaea9354a09f169",
    measurementId: "G-T7FVX8DW2Z"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const authContainer = document.getElementById("authContainer");
  const mainContainer = document.getElementById("mainContainer");
  const googleSignInBtn = document.getElementById("googleSignInBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const balanceEl = document.getElementById("balance");
  const mineBtn = document.getElementById("mineBtn");
  const timerText = document.getElementById("timerText");
  const refCodeEl = document.getElementById("refCode");
  const refCountEl = document.getElementById("refCount");
  const historyList = document.getElementById("historyList");
  const tabs = document.querySelectorAll(".tabs button");
  const tabContents = document.querySelectorAll(".tab-content");
  const refLink = document.getElementById("refLink");
  const copyBtn = document.getElementById("copyBtn");
  const gameResult = document.getElementById("gameResult");
  const claimBtn = document.getElementById("claimBtn");
  const boxes = document.querySelectorAll(".boxes .box");

  let userDocRef = null;
  let userData = {
    balance: 0,
    mines: 0,
    lastMine: 0,
    history: [],
    referrals: 0,
    referredBy: null,
    signupTime: 0,
    lastGame: 0
  };
  const MINE_INTERVAL = 2 * 60 * 60 * 1000;
  const MAX_DAILY_MINES = 5;

  // Referral bonus function
  async function applyReferralBonus(refUid) {
    const refUserRef = doc(db, "users", refUid);
    try {
      await runTransaction(db, async (t) => {
        const refUserDoc = await t.get(refUserRef);
        if (!refUserDoc.exists()) return;
        const d = refUserDoc.data();
        t.update(refUserRef, {
          balance: (d.balance || 0) + 50,
          referrals: (d.referrals || 0) + 1,
        });
      });
    } catch (e) {
      console.error("Referral bonus error:", e);
    }
  }

  // Google sign in event
  googleSignInBtn.addEventListener("click", async () => {
    googleSignInBtn.disabled = true;
    try {
      const result = await signInWithPopup(auth, new GoogleAuthProvider());
      const user = result.user;
      userDocRef = doc(db, "users", user.uid);
      const snapshot = await getDoc(userDocRef);
      let refCodeFromURL = new URLSearchParams(window.location.search).get("ref") || null;
      if (!snapshot.exists()) {
        await setDoc(userDocRef, {
          name: user.displayName || "",
          email: user.email,
          balance: 0,
          mines: 0,
          lastMine: 0,
          referrals: 0,
          history: [],
          refCode: user.uid,
          referredBy: refCodeFromURL,
          signupTime: Date.now(),
          lastGame: 0
        });
        if (refCodeFromURL) await applyReferralBonus(refCodeFromURL);
      }
      await loadUser(user.uid);
      afterLoginUI();
    } catch (error) {
      alert("Google Sign In Error: " + error.message);
    } finally {
      googleSignInBtn.disabled = false;
    }
  });

  // Logout event
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    resetUI();
  });

  // On auth state changed
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      userDocRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(userDocRef);
      if (docSnap.exists()) {
        userData = docSnap.data();
        await loadUser(user.uid);
        afterLoginUI();
      }
    } else {
      resetUI();
    }
  });

  // Load user data and render UI
  async function loadUser(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    if (snap.exists()) {
      userData = snap.data();
      balanceEl.textContent = userData.balance || 0;
      refCodeEl.textContent = userData.refCode || uid;
      refCountEl.textContent = userData.referrals || 0;
      refLink.value = window.location.href.split('?')[0] + "?ref=" + (userData.refCode || userDocRef.id);
      renderHistory();
      updateMiningTimer();
    }
  }

  // Render mining history
  function renderHistory() {
    historyList.innerHTML = "";
    (userData.history || []).slice().reverse().forEach(item => {
      const li = document.createElement("li");
      li.textContent = `Mined ${item.amount} MDC at ${new Date(item.timestamp).toLocaleString()}`;
      historyList.appendChild(li);
    });
  }

  // Format remaining time for mining timer
  function formatTime(ms) {
    const h = Math.floor(ms / 3600000);
    const m = Math.floor((ms % 3600000) / 60000);
    const s = Math.floor((ms % 60000) / 1000);
    return `${h.toString().padStart(2, "0")}:${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
  }

  // Update mining timer display and enable/disable mine button
  function updateMiningTimer() {
    const now = Date.now();
    let remaining = userData.lastMine + MINE_INTERVAL - now;
    if (remaining <= 0 || userData.mines >= MAX_DAILY_MINES) {
      timerText.textContent = "Ready";
      mineBtn.disabled = false;
    } else {
      timerText.textContent = formatTime(remaining);
      mineBtn.disabled = true;
      requestAnimationFrame(updateMiningTimer);
    }
  }

  // Mine button click event
  mineBtn.addEventListener("click", async () => {
    if (userData.mines >= MAX_DAILY_MINES) {
      alert("Daily mining limit reached!");
      return;
    }
    userData.balance += 10;
    userData.mines += 1;
    userData.lastMine = Date.now();
    const newHist = { amount: 10, timestamp: Date.now() };
    await updateDoc(userDocRef, {
      balance: userData.balance,
      mines: userData.mines,
      lastMine: userData.lastMine,
      history: arrayUnion(newHist)
    });

    // Referral 2% bonus for 7 days
    if (userData.referredBy && Date.now() - userData.signupTime <= 7 * 24 * 60 * 60 * 1000) {
      const refUserRef = doc(db, "users", userData.referredBy);
      const refSnap = await getDoc(refUserRef);
      if (refSnap.exists()) {
        const bonus = 10 * 0.02;
        await updateDoc(refUserRef, {
          balance: (refSnap.data().balance || 0) + bonus,
        });
      }
    }
    userData.history.push(newHist);
    balanceEl.textContent = userData.balance;
    renderHistory();
    updateMiningTimer();
  });

  // Tab switching logic
  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabContents.forEach(tc => tc.classList.remove("active"));
      document.getElementById(tab.dataset.tab).classList.add("active");
    });
  });

  // Referral Copy Button
  copyBtn.addEventListener("click", () => {
    refLink.select();
    refLink.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(refLink.value);
    alert("Referral link copied!");
  });

  // Lucky Box Game Logic
  let reward = 0;
  boxes.forEach(box => {
    box.addEventListener("click", () => {
      if (Date.now() - userData.lastGame < 24 * 60 * 60 * 1000) {
        gameResult.textContent = "‚è≥ You can play only once every 24 hours!";
        return;
      }
      reward = Math.floor(Math.random() * 50) + 1;
      gameResult.textContent = `üéâ You won ${reward} MDC! Click Claim to add.`;
      claimBtn.style.display = "inline-block";
    });
  });

  claimBtn.addEventListener("click", async () => {
    userData.balance += reward;
    userData.lastGame = Date.now();
    await updateDoc(userDocRef, {
      balance: userData.balance,
      lastGame: userData.lastGame
    });
    balanceEl.textContent = userData.balance;
    gameResult.textContent = `‚úÖ ${reward} MDC added to your wallet!`;
    claimBtn.style.display = "none";
  });

  // UI helpers
  function afterLoginUI() {
    authContainer.style.display = "none";
    mainContainer.style.display = "block";
  }

  function resetUI() {
    authContainer.style.display = "block";
    mainContainer.style.display = "none";
    userData = {
      balance: 0,
      mines: 0,
      lastMine: 0,
      history: [],
      referrals: 0,
      referredBy: null,
      signupTime: 0,
      lastGame: 0
    };
    balanceEl.textContent = 0;
    historyList.innerHTML = "";
    timerText.textContent = "00:00:00";
  }
</script>
</body>
</html>
