<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Moo Deng Coin</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet" />
<meta name="theme-color" content="#FFD700" />
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<style>
  /* ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Æ‡¶§ CSS ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
  * {margin:0; padding:0; box-sizing:border-box; font-family: Arial, sans-serif;}
  body {
    background: #0d0d0d; color: #fff;
    display: flex; justify-content: center;
    min-height: 100vh; padding: 20px;
  }
  .container {
    max-width: 450px; width: 100%;
    background: #111; padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0, 255, 221, 0.3);
  }
  h1, h2, h3 {margin-bottom: 10px;}
  .app-header {
    display: flex; align-items: center; justify-content: space-between;
  }
  h1 {
    font-family: 'Cinzel Decorative', serif;
    font-weight: bold; font-size: 26px;
    background: linear-gradient(90deg, #FFD700, #FFA500);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: glow 2s infinite alternate;
    display: flex; align-items: center; gap: 8px;
    flex-wrap: wrap;
  }
  @keyframes glow {
    from {text-shadow: 0 0 5px #FFD700;}
    to {text-shadow: 0 0 20px #FFA500;}
  }
  .coin-symbol {
    width: 50px; aspect-ratio: 1/1; border-radius: 50%;
    background: radial-gradient(circle, #FFD700 10%, #FFA500 70%, #b8860b 100%);
    display: inline-flex; align-items: center; justify-content: center;
    font-size: 24px; color: #fff; font-weight: bold;
    margin-left: 6px;
    animation: coinPulse 2s infinite;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.9),
      inset 0 0 6px #fff;
  }
  @keyframes coinPulse {
    0% {transform: scale(1);}
    50% {transform: scale(1.15);}
    100% {transform: scale(1);}
  }
  .logout-btn {
    background: #ff4444; color: #fff; padding: 8px 14px;
    border: none; border-radius: 5px; cursor: pointer;
  }
  #authContainer {display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; text-align: center;}
  #googleSignInBtn {
    background: #fff; border: none; padding: 12px 20px;
    border-radius: 8px; font-size: 16px; font-weight: bold;
    cursor: pointer; display: flex; align-items: center;
    gap: 8px; color: #000; margin-top: 20px;
  }
  #googleSignInBtn i {font-size: 20px;}
  .install-instructions {
    margin-top: 20px; font-size: 14px; line-height: 1.6; color: #ccc; text-align: center;
  }
  .install-instructions h3 {color: #FFD700; margin-bottom: 10px;}
  .wallet, .referral, .tabs, .tab-content {margin-top: 20px;}
  .wallet span, .referral span {font-weight: bold; color: #00ffdd;}
  .mining-container {
    position: relative; width: 220px; margin: 20px auto;
  }
  .circle {
    width: 100%; aspect-ratio: 1/1; border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #fff8b0 0%, #FFD700 30%, #FFA500 70%, #7a4a00 100%);
    display: flex; justify-content: center; align-items: center;
    font-size: 22px; font-weight: bold;
    color: #000;
    text-shadow: 0 0 4px #fff, 0 0 2px #000;
    box-shadow: inset -3px -3px 8px rgba(0,0,0,0.6),
                inset 3px 3px 6px rgba(255,255,255,0.6),
                0 0 20px rgba(255,215,0,0.6);
  }
  #mineBtn {
    display: block; margin: 20px auto; padding: 15px 25px;
    font-size: 18px; font-weight: bold;
    background: linear-gradient(90deg, #FFD700, #FFA500);
    border: none; border-radius: 50px;
    color: #111;
    box-shadow: 0 4px 10px rgba(255,215,0,0.5);
    cursor: pointer;
    transition: 0.3s;
  }
  #mineBtn:hover {
    background: linear-gradient(90deg, #FFA500, #FFD700);
    transform: scale(1.05);
  }
  .tabs {display: flex; justify-content: space-around;}
  .tabs button {
    flex: 1; margin: 0 5px; padding: 10px;
    background: #00ffdd; border: none; border-radius: 5px;
    cursor: pointer; color: #000; font-weight: bold;
  }
  .tab-content {
    display: none; margin-top: 20px; background: #111;
    padding: 15px; border-radius: 10px;
  }
  .tab-content.active {display: block;}
  .referral input.copy-input {
    flex: 1; padding: 6px 10px; border: none; border-radius: 5px;
    background: #222; color: #0ff; font-weight: bold; font-size: 14px;
    user-select: all;
  }
  .referral .copy-btn {
    background: #00ffdd; border: none; border-radius: 5px;
    padding: 5px 12px; cursor: pointer; font-weight: bold;
    color: #000; margin-left: 8px;
  }
  .game-section {margin-top: 30px; text-align: center;}
  .boxes {
    display: flex; justify-content: center; gap: 15px; margin: 20px 0;
  }
  .boxes .box {
    width: 70px; height: 70px;
    background: linear-gradient(135deg, #ffd700, #ffa500);
    color: #fff; font-size: 28px; font-weight: bold;
    border-radius: 15px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(255, 165, 0, 0.6),
      inset 0 0 10px rgba(255, 255, 255, 0.3);
    border: 2px solid #fff5a1;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    user-select: none; user-drag: none;
  }
  .boxes .box:hover {
    background: linear-gradient(135deg, #fff700, #ffb700);
    box-shadow: 0 6px 12px rgba(255, 215, 0, 0.8),
      inset 0 0 14px rgba(255, 255, 255, 0.6);
    transform: scale(1.1);
  }
  #gameResult {color: #0ff; font-weight: bold;}
  #claimBtn {
    display: none; background: #00ffdd; border: none; border-radius: 5px;
    padding: 10px 20px; cursor: pointer; color: #000;
  }
</style>
</head>
<body>

<!-- Authentication Container -->
<div class="container" id="authContainer">
  <h2>Sign In</h2>
  <button id="googleSignInBtn"><i class="fab fa-google"></i> Sign in with Google</button>
  <div class="install-instructions">
    <h3>Install MDC</h3>
    <p>1. Tap on the ‚ãÆ menu in your browser's right corner.</p>
    <p>2. Scroll down and select "Add to Home Screen".</p>
    <p>3. Open MDC from your Home Screen!</p>
    <p>4. Keep this tab open to keep mining active.</p>
  </div>
</div>

<!-- Main Container -->
<div class="container" id="mainContainer" style="display:none;">
  <div class="app-header">
    <h1>Moo Deng COIN <span class="coin-symbol">ü¶õ</span></h1>
    <button id="logoutBtn" class="logout-btn">Logout</button>
  </div>

  <div class="wallet">
    <h2>Wallet</h2>
    <p>MDC Balance: <span id="balance">0</span></p>
    <button id="mineBtn">Mine Token</button>
  </div>

  <div class="mining-container">
    <div class="circle"><span id="timerText">00:00:00</span></div>
  </div>

  <!-- Referral Section -->
  <div class="referral">
    <h3>Your Referral</h3>
    <p>Code: <span id="refCode"></span></p>
    <div style="display:flex; gap:8px; margin-top: 10px;">
      <input class="copy-input" id="refLink" readonly>
      <button class="copy-btn" id="copyBtn">Copy</button>
    </div>
    <p>Referred Users: <span id="refCount">0</span></p>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button data-tab="historyTab" class="active">History</button>
    <button data-tab="whitepaperTab">White Paper</button>
  </div>
  <div class="tab-content active" id="historyTab">
    <h3>Mining History</h3>
    <ul id="historyList"></ul>
  </div>
  <div class="tab-content" id="whitepaperTab">
    <h3>White Paper</h3>
    <p>Coming soon...</p>
  </div>

  <!-- Lucky Box Game -->
  <div class="game-section">
    <h3>Lucky Box Game üéÅ</h3>
    <p>You can play once every 24 hours. Pick a box and win 1‚Äì50 MDC randomly!</p>
    <div class="boxes">
      <div class="box" data-index="1">?</div>
      <div class="box" data-index="2">?</div>
      <div class="box" data-index="3">?</div>
      <div class="box" data-index="4">?</div>
      <div class="box" data-index="5">?</div>
    </div>
    <p id="gameResult"></p>
    <button id="claimBtn">Claim Coins</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBRitTsyqXfk6XNh3t1j0boebQa1LNQkKs",
    authDomain: "moo-deng-coin.firebaseapp.com",
    projectId: "moo-deng-coin",
    storageBucket: "moo-deng-coin.appspot.com",
    messagingSenderId: "629636349388",
    appId: "1:629636349388:web:a9a7924aaea9354a09f169",
    measurementId: "G-T7FVX8DW2Z"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const authContainer = document.getElementById("authContainer");
  const mainContainer = document.getElementById("mainContainer");
  const googleSignInBtn = document.getElementById("googleSignInBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const balanceEl = document.getElementById("balance");
  const mineBtn = document.getElementById("mineBtn");
  const timerText = document.getElementById("timerText");
  const refCodeEl = document.getElementById("refCode");
  const refCountEl = document.getElementById("refCount");
  const historyList = document.getElementById("historyList");
  const tabs = document.querySelectorAll(".tabs button");
  const tabContents = document.querySelectorAll(".tab-content");
  const refLink = document.getElementById("refLink");
  const copyBtn = document.getElementById("copyBtn");
  const gameResult = document.getElementById("gameResult");
  const claimBtn = document.getElementById("claimBtn");
  const boxes = document.querySelectorAll(".boxes .box");

  let userDocRef = null;
  let userData = {
    balance: 0,
    lastMine: 0,
    history: [],
    referrals: 0,
    referredBy: null,
    signupTime: 0,
    lastGame: 0
  };
  const MINE_INTERVAL = 2 * 60 * 60 * 1000; // 2 hours
  const COMMISSION_PERIOD = 7 * 24 * 60 * 60 * 1000; // 7 days

  // Interval to update mining timer every second continuously
  let miningTimerInterval = null;
  function updateMiningTimer() {
    if (miningTimerInterval) clearInterval(miningTimerInterval);

    miningTimerInterval = setInterval(() => {
      const now = Date.now();
      const elapsed = now - (userData.lastMine || 0);
      let timeLeft = MINE_INTERVAL - elapsed;
      if (timeLeft < 0) {
        timeLeft = 0;
        clearInterval(miningTimerInterval);
        miningTimerInterval = null;
      }
      const hours = Math.floor(timeLeft / (1000 * 60 * 60));
      const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
      timerText.textContent = `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    }, 1000);
  }

  // Referral bonus function with logging and check
  async function applyReferralBonus(refUid) {
    console.log("Applying referral bonus for ID:", refUid);
    if (!refUid) {
      console.warn("No referral UID provided!");
      return;
    }
    const refUserRef = doc(db, "users", refUid);
    try {
      await runTransaction(db, async (t) => {
        const refUserDoc = await t.get(refUserRef);
        if (!refUserDoc.exists()) {
          console.warn("Referral user doc does not exist.");
          return;
        }
        const d = refUserDoc.data();
        const newBalance = (d.balance || 0) + 50;
        const newRefCount = (d.referrals || 0) + 1;
        t.update(refUserRef, {
          balance: newBalance,
          referrals: newRefCount,
        });
        console.log("Referral bonus applied:", newBalance, newRefCount);
      });
    } catch (e) {
      console.error("Referral bonus transaction error:", e);
    }
  }

  // Referral commission for mining amounts for 7 days
  async function applyReferralCommission(amount) {
    if (!userData.referredBy) return;
    const now = Date.now();
    if (now - userData.signupTime > COMMISSION_PERIOD) return;
    const refUserRef = doc(db, "users", userData.referredBy);
    try {
      await runTransaction(db, async (t) => {
        const refUserDoc = await t.get(refUserRef);
        if (!refUserDoc.exists()) return;
        const d = refUserDoc.data();
        const commissionAmount = Math.floor(amount * 0.02);
        if (commissionAmount <= 0) return;
        t.update(refUserRef, {
          balance: (d.balance || 0) + commissionAmount,
        });
      });
    } catch (e) {
      console.error("Referral commission error:", e);
    }
  }

  googleSignInBtn.addEventListener("click", async () => {
    googleSignInBtn.disabled = true;
    try {
      const result = await signInWithPopup(auth, new GoogleAuthProvider());
      const user = result.user;
      userDocRef = doc(db, "users", user.uid);
      const snapshot = await getDoc(userDocRef);
      let refCodeFromURL = new URLSearchParams(window.location.search).get("ref") || null;
      if (!snapshot.exists()) {
        await setDoc(userDocRef, {
          name: user.displayName || "",
          email: user.email,
          balance: 0,
          lastMine: 0,
          referrals: 0,
          history: [],
          refCode: user.uid,
          referredBy: refCodeFromURL,
          signupTime: Date.now(),
          lastGame: 0
        });
        if (refCodeFromURL) await applyReferralBonus(refCodeFromURL);
      }
      await loadUser(user.uid);
      afterLoginUI();
    } catch (error) {
      alert("Google Sign In Error: " + error.message);
    } finally {
      googleSignInBtn.disabled = false;
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    resetUI();
  });

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      userDocRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(userDocRef);
      if (docSnap.exists()) {
        userData = docSnap.data();
        await loadUser(user.uid);
        afterLoginUI();
      }
    } else {
      resetUI();
    }
  });

  async function loadUser(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    if (snap.exists()) {
      userData = snap.data();
      balanceEl.textContent = userData.balance || 0;
      refCodeEl.textContent = userData.refCode || uid;
      refCountEl.textContent = userData.referrals || 0;
      refLink.value = window.location.href.split('?')[0] + "?ref=" + (userData.refCode || userDocRef.id);
      renderHistory();
      updateMiningTimer();
    }
  }

  function renderHistory() {
    historyList.innerHTML = "";
    (userData.history || []).slice().reverse().forEach(item => {
      const li = document.createElement("li");
      li.textContent = `Mined ${item.amount} MDC on ${new Date(item.time).toLocaleString()}`;
      historyList.appendChild(li);
    });
  }

  function afterLoginUI() {
    authContainer.style.display = "none";
    mainContainer.style.display = "block";
  }

  function resetUI() {
    authContainer.style.display = "flex";
    mainContainer.style.display = "none";
    balanceEl.textContent = "0";
    refCodeEl.textContent = "";
    refCountEl.textContent = "0";
    historyList.innerHTML = "";
  }

  mineBtn.addEventListener("click", async () => {
    const now = Date.now();

    if (now - userData.lastMine < MINE_INTERVAL) {
      alert("Please wait until the timer resets to mine again.");
      return;
    }

    const fixedAmount = 10;

    userData.balance += fixedAmount;
    userData.lastMine = now;
    userData.history.push({ amount: fixedAmount, time: now });

    try {
      await updateDoc(userDocRef, {
        balance: userData.balance,
        lastMine: userData.lastMine,
        history: userData.history,
      });
      balanceEl.textContent = userData.balance;
      renderHistory();
      updateMiningTimer();

      await applyReferralCommission(fixedAmount);
    } catch (error) {
      alert("Error updating balance: " + error.message);
    }
  });

  copyBtn.addEventListener("click", () => {
    refLink.select();
    refLink.setSelectionRange(0, 99999);
    document.execCommand("copy");
    alert("Referral link copied to clipboard!");
  });

  tabs.forEach(btn => {
    btn.addEventListener("click", () => {
      tabs.forEach(b => b.classList.remove("active"));
      tabContents.forEach(tc => tc.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });

  let gamePlayedToday = false;

  function canPlayGame() {
    const now = Date.now();
    return now - userData.lastGame > 24 * 60 * 60 * 1000;
  }

  boxes.forEach(box => {
    box.addEventListener("click", () => {
      if (gamePlayedToday || !canPlayGame()) {
        gameResult.textContent = "You can only play once every 24 hours.";
        return;
      }
      gamePlayedToday = true;
      const prize = Math.floor(Math.random() * 50) + 1;
      gameResult.textContent = `You won ${prize} MDC!`;
      claimBtn.style.display = "inline-block";

      claimBtn.onclick = async () => {
        userData.balance += prize;
        userData.lastGame = Date.now();
        gamePlayedToday = false;

        try {
          await updateDoc(userDocRef, {
            balance: userData.balance,
            lastGame: userData.lastGame,
          });
          balanceEl.textContent = userData.balance;
          gameResult.textContent = "";
          claimBtn.style.display = "none";
        } catch (error) {
          alert("Error updating game reward: " + error.message);
        }
      };
    });
  });

</script>
</body>
</html>
