<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Moo Deng Coin - Secure Firebase Version</title>
<style>
  *{ margin:0; padding:0; box-sizing:border-box; font-family:'Arial', sans-serif;}
  body{ background:#0d0d0d; color:#fff; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; padding:20px;}
  a{ color:#00ffdd; text-decoration:none;}
  button{ cursor:pointer; background:#00ffdd; border:none; padding:10px 20px; color:#000; font-weight:bold; border-radius:5px; transition:0.3s;}
  button:hover{ background:#00ccaa;}
  .container{ max-width:450px; width:100%; background:#111; padding:20px; border-radius:10px; box-shadow:0 0 20px rgba(0,255,221,0.3);}
  h1,h2,h3{ margin-bottom:10px;}
  .hide{ display:none;}
  #timerText{font-weight:bold; font-size:1.5em; color:#0ff;}
  .warning{color:#ff5555; font-weight:bold; margin-top:10px;}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js"></script>

</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="container">
  <h1>Moo Deng Coin Login</h1>
  <input type="email" id="loginEmail" placeholder="Email Address" />
  <input type="password" id="loginPassword" placeholder="Password" />
  <button id="loginBtn">Login</button>
  <p>Don't have an account? <a href="#" id="showRegister">Register</a></p>
</div>

<!-- Register Screen -->
<div id="registerScreen" class="container hide">
  <h1>Register Account</h1>
  <input type="email" id="registerEmail" placeholder="Email Address" />
  <input type="password" id="registerPassword" placeholder="Password" />
  <input type="password" id="registerConfirmPassword" placeholder="Confirm Password" />
  <button id="registerBtn">Register</button>
  <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
</div>

<!-- Main App Container -->
<div id="appContainer" class="container hide">
  <h1>Welcome, <span id="userEmail"></span></h1>

  <div class="mining-container">
    <div id="timerText">Ready to mine</div>
    <button id="mineBtn">Mine Token</button>
    <p class="warning" id="miningWarning"></p>
  </div>

  <button id="logoutBtn" style="margin-top:20px;">Logout</button>
</div>

<script>
  // Firebase config (আপনার Firebase প্রজেক্ট থেকে বিকল্প নিন)
  const firebaseConfig = {
    apiKey: "AIzaSyBRitTsyqXfk6XNh3t1j0boebQa1LNQkKs",
    authDomain: "moo-deng-coin.firebaseapp.com",
    projectId: "moo-deng-coin",
    storageBucket: "moo-deng-coin.firebasestorage.app",
    messagingSenderId: "629636349388",
    appId: "1:629636349388:web:a9a7924aaea9354a09f169",
    measurementId: "G-T7FVX8DW2Z"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // DOM elements
  const loginScreen = document.getElementById('loginScreen');
  const registerScreen = document.getElementById('registerScreen');
  const appContainer = document.getElementById('appContainer');
  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const showRegister = document.getElementById('showRegister');
  const showLogin = document.getElementById('showLogin');
  const userEmail = document.getElementById('userEmail');
  const mineBtn = document.getElementById('mineBtn');
  const timerText = document.getElementById('timerText');
  const miningWarning = document.getElementById('miningWarning');

  // Constants
  const MINE_INTERVAL = 2 * 60 * 60 * 1000; // 2 hours
  const MAX_DAILY_MINES = 5;

  // Variables
  let currentUser = null;
  let miningIntervalId = null;

  // Show register form
  showRegister.addEventListener('click', (e) => {
    e.preventDefault();
    loginScreen.classList.add('hide');
    registerScreen.classList.remove('hide');
  });

  // Show login form
  showLogin.addEventListener('click', (e) => {
    e.preventDefault();
    registerScreen.classList.add('hide');
    loginScreen.classList.remove('hide');
  });

  // Register user with detailed error popup
  registerBtn.addEventListener('click', async () => {
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('registerConfirmPassword').value;

    if (!email || !password || !confirmPassword) {
      alert('All fields are required!');
      return;
    }
    if (password !== confirmPassword) {
      alert('Passwords do not match!');
      return;
    }
    if (password.length < 6) {
      alert('Password should be at least 6 characters!');
      return;
    }

    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      const userId = userCredential.user.uid;

      // Init user data in Firestore
      await db.collection('users').doc(userId).set({
        email,
        userId,
        balance: 0,
        mines: 0,
        lastMine: 0,
        createdAt: Date.now(),
      });

      alert('Registration successful! Please login.');
      registerScreen.classList.add('hide');
      loginScreen.classList.remove('hide');
    } catch (error) {
      alert(`Registration failed: ${error.message}`);
      console.error('Registration error:', error);
    }
  });

  // Login user with detailed error popup
  loginBtn.addEventListener('click', async () => {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!email || !password) {
      alert('Please enter both email and password!');
      return;
    }

    try {
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      currentUser = userCredential.user;
      await loadUserData(currentUser.uid);
      showApp();
    } catch (error) {
      alert(`Login failed: ${error.message}`);
      console.error('Login error:', error);
    }
  });

  // Logout user
  logoutBtn.addEventListener('click', async () => {
    try {
      await auth.signOut();
      currentUser = null;
      appContainer.classList.add('hide');
      loginScreen.classList.remove('hide');
      stopMining();
    } catch (error) {
      alert(`Logout error: ${error.message}`);
      console.error('Logout error:', error);
    }
  });

  // Load user Firestore data with error popup
  async function loadUserData(userId) {
    try {
      const doc = await db.collection('users').doc(userId).get();
      if (doc.exists) {
        currentUser = { uid: userId, ...doc.data() };
        userEmail.textContent = currentUser.email;
      } else {
        throw new Error('User data not found.');
      }
    } catch (error) {
      alert(`Failed to load user data: ${error.message}`);
      console.error('Load user data error:', error);
    }
  }

  // Show App UI
  function showApp() {
    loginScreen.classList.add('hide');
    registerScreen.classList.add('hide');
    appContainer.classList.remove('hide');
    miningWarning.textContent = '';
    updateMiningTimer();
  }

  // Update mining timer
  function updateMiningTimer() {
    if (!currentUser) return;

    const now = Date.now();
    let remaining = currentUser.lastMine + MINE_INTERVAL - now;

    if (currentUser.mines >= MAX_DAILY_MINES) {
      timerText.textContent = 'Daily limit reached';
      mineBtn.disabled = true;
      miningWarning.textContent = 'You have reached your daily mining limit.';
      stopMining();
      return;
    }

    if (remaining <= 0) {
      timerText.textContent = 'Ready to mine';
      mineBtn.disabled = false;
      miningWarning.textContent = '';
    } else {
      mineBtn.disabled = true;
      miningWarning.textContent = 'Mining cooldown active. Please wait.';
      let hrs = Math.floor(remaining / 3600000);
      let mins = Math.floor((remaining % 3600000) / 60000);
      let secs = Math.floor((remaining % 60000) / 1000);
      timerText.textContent = `${hrs.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;

      setTimeout(updateMiningTimer, 1000);
    }
  }

  // Start mining interval (simulate)
  function startMiningCycle() {
    miningIntervalId = setInterval(async () => {
      if (!currentUser) {
        stopMining();
        return;
      }

      if (currentUser.mines >= MAX_DAILY_MINES) {
        stopMining();
        return;
      }

      const now = Date.now();
      if (now - currentUser.lastMine < MINE_INTERVAL) return;

      await mineToken();
    }, 1000*10); // check every 10 seconds
  }

  // Stop mining interval
  function stopMining() {
    if (miningIntervalId) {
      clearInterval(miningIntervalId);
      miningIntervalId = null;
    }
  }

  // Mine token function (simulate mining tokens) with error popup
  async function mineToken() {
    const now = Date.now();

    if (currentUser.mines >= MAX_DAILY_MINES) return;
    if (now - currentUser.lastMine < MINE_INTERVAL && currentUser.lastMine !== 0) return;

    try {
      currentUser.mines += 1;
      currentUser.lastMine = now;
      currentUser.balance = (currentUser.balance || 0) + 10;

      await db.collection('users').doc(currentUser.uid).update({
        mines: currentUser.mines,
        lastMine: currentUser.lastMine,
        balance: currentUser.balance
      });

      alert('Mining successful! You earned 10 MDC.');
      updateMiningTimer();
    } catch (error) {
      alert(`Error during mining: ${error.message}`);
      console.error('Mining error:', error);
    }
  }

  // Button click mining
  mineBtn.addEventListener('click', () => {
    if (!currentUser) {
      alert('You must log in first!');
      return;
    }
    mineToken();
  });

  // Listen for Firebase Auth state change
  auth.onAuthStateChanged(async user => {
    if (user) {
      await loadUserData(user.uid);
      showApp();
      startMiningCycle();
    } else {
      stopMining();
      appContainer.classList.add('hide');
      loginScreen.classList.remove('hide');
    }
  });

  // Detect tab close event - stop mining
  window.addEventListener('beforeunload', (e) => {
    stopMining();
  });

  // Optional: Global uncaught error handler to catch unexpected errors
  window.onerror = function(message, source, lineno, colno, error) {
    alert(`Unexpected error: ${message} at ${source}:${lineno}:${colno}`);
    console.error('Global error:', error);
  }
</script>

</body>
</html>
